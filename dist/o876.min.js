"use strict";var O2={};Function.prototype.createClass=function(a){var b;return b=function(){"__construct"in this&&this.__construct.apply(this,arguments)},void 0===a?b:"object"==typeof a?b.extendPrototype(a):null},O2._superizeFunction=function(f,fParent){var fNew,s="fNew = function() {\nvar __inherited = (function() {\n\treturn fParent.apply(this, arguments);\n}).bind(this);\nvar __function = "+f.toString()+";\nreturn __function.apply(this, arguments);\n}\n";return eval(s)},Function.prototype.extendPrototype=function(a){var b,c,d="";a instanceof Function&&(a=a.prototype);for(d in a)if(b=a[d],d in this.prototype&&this.prototype[d]instanceof Function){if(c=this.prototype[d],!(b instanceof Function))throw new Error("o2: method "+d+" overridden by property.");this.prototype[d]=O2._superizeFunction(b,c)}else this.prototype[d]=a[d];return this},Function.prototype.extendClass=function(a,b){var c=this.createClass().extendPrototype(a).extendPrototype(b);return c},O2.createObject=function(a,b){for(var c,d=a.split("."),e=d.pop(),f=window;d.length;)c=d.shift(),c in f||(f[c]={}),f=f[c];if(e in f)for(var g in b)f[e][g]=b[g];else f[e]=b;return f},O2.loadObject=function(a,b){for(var c,d=a.split("."),e=b||window,f="";d.length>1;){if(c=d.shift(),!(c in e))throw new Error("could not find "+c+" in "+f.substr(1));e=e[c],f+="."+c}var g=d[0];if(g in e)return e[g];throw new Error("could not find "+g+" in "+f.substr(1))},O2._loadObject=function(a,b){return console.warn('O2._loadObject is deprecated. Use the brand new O2.loadObject, which do the same thing, but without this "_" in front of the name.'),console.trace(),O2.loadObject(a,b)},O2.createClass=function(a,b){return O2.createObject(a,Function.createClass(b))},O2.extendClass=function(a,b,c){return"string"==typeof b&&(b=O2.loadObject(b)),O2.createObject(a,Function.extendClass(b,c))},O2.mixin=function(a,b){var c;"string"==typeof a&&(a=O2.loadObject(a)),"function"==typeof b?(c=new b,c.mixin(a)):(c=b,a.extendPrototype(c))},O2.createObject("Fairy.Mixin.GridProxy",{width:function(a){return void 0===a?this._grid.width():(this._grid.width(a),this)},height:function(a){return void 0===a?this._grid.height():(this._grid.height(a),this)}}),O2.createClass("O876.Mixin.Data",{mixin:function(a){a.extendPrototype({_DataContainer:null,setData:function(a,b){return this.data(a,b)},getData:function(a){return this.data(a)},data:function(a,b){null===this._DataContainer&&(this._DataContainer={});var c=this._DataContainer;if(void 0===b){if(void 0===a)return c;if("object"!=typeof a)return a in c?c[a]:null;for(var d in a)c[d]=a[d]}else c[a]=b;return this}})}}),O2.createClass("O876.Mixin.Events",{mixin:function(a){a.extendPrototype({_WeirdEventHandlers:null,on:function(a,b){null===this._WeirdEventHandlers&&(this._WeirdEventHandlers={});var c=this._WeirdEventHandlers;return a in c||(c[a]=[]),c[a].push(b),this},one:function(a,b){var c;return c=function(){b.apply(this,Array.prototype.slice.call(arguments,0)),this.off(a,c),c=null}.bind(this),this.on(a,c)},off:function(a,b){if(null===this._WeirdEventHandlers)throw new Error('no event "'+a+'" defined');if(void 0===a)this._WeirdEventHandlers={};else if(!(a in this._WeirdEventHandlers))throw new Error('no event "'+a+'" defined');var c,d,e=this._WeirdEventHandlers;if(void 0!==b){if(c=e[a],d=c.indexOf(b),d<0)throw new Error('this handler is not defined for event "'+a+'"');c.splice(d,1)}else e[a]=[];return this},trigger:function(a){if(null===this._WeirdEventHandlers)return this;var b=this._WeirdEventHandlers;if(!(a in b))return this;var c=Array.prototype.slice.call(arguments,1);return b[a].forEach(function(a){a.apply(this,c)},this),this}})}}),O2.createClass("O876.Mixin.Prop",{_buildPropFunction:function(a){return function(b){return void 0===b?this[a]:(this[a]=b,this)}},mixin:function(a){var b={prop:function(a,b){return void 0===b?this[a]:(this[a]=b,this)}};for(var c in a.prototype)c.match(/^_/)&&(c.substr(1)in a.prototype||"function"==typeof a.prototype[c]||(b[c.substr(1)]=this._buildPropFunction(c)));a.extendPrototype(b)}}),O2.createClass("O876.Astar.Point",{x:0,y:0,__construct:function(a,b){this.x=a,this.y=b}}),O2.createClass("O876.Astar.Nood",{fGCost:0,fHCost:0,fFCost:0,oParent:null,oPos:null,__construct:function(){this.oParent=new O876.Astar.Point(0,0),this.oPos=new O876.Astar.Point(0,0)},isRoot:function(){return this.oParent.x==this.oPos.x&&this.oParent.y==this.oPos.y}}),O2.createClass("O876.Astar.NoodList",{aList:null,__construct:function(){this.aList={}},add:function(a){this.set(a.oPos.x,a.oPos.y,a)},set:function(a,b,c){this.aList[this.getKey(a,b)]=c},count:function(){var a=0,b="";for(b in this.aList)a++;return a},exists:function(a,b){return this.getKey(a,b)in this.aList},getKey:function(a,b){return a.toString()+"__"+b.toString()},get:function(a,b){return this.exists(a,b)?this.aList[this.getKey(a,b)]:null},del:function(a,b){delete this.aList[this.getKey(a,b)]},empty:function(){var a="";for(a in this.aList)return!1;return!0}}),O2.createClass("O876.Astar.Grid",{bUseDiagonals:!1,MAX_ITERATIONS:2048,nIterations:0,aTab:null,nWidth:0,nHeight:0,oOpList:null,oClList:null,aPath:null,xLast:0,yLast:0,nLastDir:0,GRID_BLOCK_WALKABLE:0,init:function(a){"grid"in a&&(this.aTab=a.grid,this.nHeight=a.grid.length,this.nWidth=a.grid[0].length),"diagonals"in a&&(this.bUseDiagonals=a.diagonals),"max"in a&&(this.MAX_ITERATIONS=a.max),"walkable"in a&&(this.GRID_BLOCK_WALKABLE=a.walkable)},reset:function(){this.oOpList=new O876.Astar.NoodList,this.oClList=new O876.Astar.NoodList,this.aPath=[],this.nIterations=0},distance:function(a,b,c,d){var e=Math.sqrt((a-c)*(a-c)+(b-d)*(b-d)),f={distance:e,from:{x:a,y:b},to:{x:c,y:d}};return this.trigger("distance",f),f.distance},setCell:function(a,b,c){if(void 0===this.aTab[b]||void 0===this.aTab[b][a])throw new Error("O876.Astar: writing tile out of Grid: "+a+", "+b);this.aTab[b][a]=c},getCell:function(a,b){if(this.aTab[b]&&a<this.aTab[b].length)return this.aTab[b][a];throw new Error("O876.Astar: read tile out of Grid: "+a+", "+b)},cell:function(a,b,c){return void 0===c?this.getCell(a,b):(this.setCell(a,b,c),this)},isCellWalkable:function(a,b){try{var c={walkable:this.getCell(a,b)==this.GRID_BLOCK_WALKABLE,cell:{x:a,y:b}};return this.trigger("walkable",c),c.walkable}catch(d){return!1}},closeNood:function(a,b){var c=this.oOpList.get(a,b);c&&(this.oClList.set(a,b,c),this.oOpList.del(a,b))},addAdjacent:function(a,b,c,d){var e,f,g,h,i;for(g=-1;g<=1;g++)if(e=a+g,!(e<0||e>=this.nWidth))for(h=-1;h<=1;h++)(this.bUseDiagonals||h*g===0)&&(f=b+h,f<0||f>=this.nHeight||e==a&&f==b||this.isCellWalkable(e,f)&&(this.oClList.exists(e,f)||(i=new O876.Astar.Nood,i.fGCost=this.oClList.get(a,b).fGCost+this.distance(e,f,a,b),i.fHCost=this.distance(e,f,c,d),i.fFCost=i.fGCost+i.fHCost,i.oPos=new O876.Astar.Point(e,f),i.oParent=new O876.Astar.Point(a,b),this.oOpList.exists(e,f)?i.fFCost<this.oOpList.get(e,f).fFCost&&this.oOpList.set(e,f,i):this.oOpList.set(e,f,i))))},bestNood:function(a){var b,c=null,d="";for(d in a.aList)b=a.aList[d],null===c?c=b:b.fFCost<c.fFCost&&(c=b);return c},find:function(a,b,c,d){this.reset();var e,f=new O876.Astar.Nood;f.oPos=new O876.Astar.Point(a,b),f.oParent=new O876.Astar.Point(a,b);var g=a,h=b;this.oOpList.add(f),this.closeNood(g,h),this.addAdjacent(g,h,c,d);for(var i=0,j=this.MAX_ITERATIONS;(g!=c||h!=d)&&!this.oOpList.empty();)if(e=this.bestNood(this.oOpList),g=e.oPos.x,h=e.oPos.y,this.closeNood(g,h),this.addAdjacent(e.oPos.x,e.oPos.y,c,d),++i>j)throw new Error("O876.Astar: too much iterations");if(this.oOpList.empty()&&(g!=c||h!=d))throw new Error("O876.Astar: no path to destination");return this.nIterations=i,this.buildPath(c,d),this.aPath},buildPath:function(a,b){var c=this.oClList.get(a,b);if(null!==c)for(;!c.isRoot();)this.aPath.unshift({x:c.oPos.x,y:c.oPos.y}),c=this.oClList.get(c.oParent.x,c.oParent.y)}}),O2.mixin(O876.Astar.Grid,O876.Mixin.Events),O2.createClass("O876.Auto.State",{_name:"",_trans:null,_current:null,_start:null,__construct:function(){this._trans=[]},run:function(){this._current=this._current.process()},reset:function(){this._current=this._start},trans:function(a){return void 0!==a?(this._trans.push(a),this):this._trans},process:function(){this.name()&&this.trigger("run",this);var a=this;return this._trans.some(function(b){return!!b.pass(this)&&(this.trigger("exit",this),a=b.state(),a.trigger("enter",a),!0)},this),a},parse:function(a,b){var c,d,e,f,g,h={};this._start=null;for(c in a)a.hasOwnProperty(c)&&(d=new O876.Auto.State,null===this._start&&(this._start=d),d.name(c),h[c]=d,b&&"exit"in b&&d.on("exit",b.exit),b&&"enter"in b&&d.on("enter",b.enter),b&&"run"in b&&d.on("run",b.run),this.trigger("state",d));for(c in a)if(a.hasOwnProperty(c)){d=a[c];for(e in d){if(!(e in h&&d.hasOwnProperty(e)))throw new Error('unknown next-state "'+e+'" in state "'+c+'"');g=d[e],f=new O876.Auto.Trans,b&&"test"in b&&f.on("test",b.test),f.test(g).state(h[e]),h[c].trans(f),this.trigger("trans",f)}}return this.reset(),h}}),O2.mixin(O876.Auto.State,O876.Mixin.Prop),O2.mixin(O876.Auto.State,O876.Mixin.Events),O2.createClass("O876.Auto.Trans",{_test:null,_state:null,pass:function(a){var b={state:a,test:this._test,result:null};return this.trigger("test",b),!!b.result}}),O2.mixin(O876.Auto.Trans,O876.Mixin.Prop),O2.mixin(O876.Auto.Trans,O876.Mixin.Events),O2.createClass("O876.Bresenham",{line:function(a,b,c,d,e){a|=0,b|=0,c|=0,d|=0;for(var f,g=Math.abs(c-a),h=Math.abs(d-b),i=a<c?1:-1,j=b<d?1:-1,k=g-h,l=0;;){if(e&&e(a,b,l)===!1)return!1;if(a==c&&b==d)break;f=k<<1,f>-h&&(k-=h,a+=i),f<g&&(k+=g,b+=j),++l}return!0}}),O2.createObject("O876.Browser",{STRINGS:{en:{wontrun:"The game won't run because some HTML 5 features are not supported by this browser",install:"You should install the latest version of one of these browsers : <b>Firefox</b>, <b>Chrome</b> or <b>Chromium</b>.",legend:"(the red colored features are not supported by your browser)"},fr:{wontrun:"Le jeu ne peut pas se lancer, car certaines fonctionnalités HTML 5 ne sont pas supportées par votre navigateur",install:"Vous devriez installer la dernière version de l'un de ces navigateurs : <b>Firefox</b>, <b>Chrome</b> ou <b>Chromium</b>.",legend:"(les fonctionnalités marquées en rouge ne sont pas supportées par votre navigateur)"}},LANGUAGE:"en",isOpera:function(){return!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0},isFirefox:function(){return"undefined"!=typeof InstallTrigger},isSafari:function(){return Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0},isChrome:function(){return!!window.chrome&&!O876.Browser.isOpera()},isIE:function(){return!!document.documentMode},getDetectedBrowserList:function(){return["Opera","Firefox","Safari","Chrome","IE"].filter(function(a){return O876.Browser["is"+a]()})},getHTML5Status:function(a){function b(a){e=e&&d[a],f.push('<tr><td style="color: '+(d[a]?"#080":"#800")+'">'+(d[a]?"✔":"✖")+"</td><td"+(d[a]?"":' style="color: #F88"')+">"+a+"</td></tr>")}var c,d={canvas:"HTMLCanvasElement"in window,audio:"HTMLAudioElement"in window,fullscreen:"webkitIsFullScreen"in document||"mozFullScreen"in document,animation:"requestAnimationFrame"in window,performance:"performance"in window&&"now"in performance,pointerlock:"pointerLockElement"in document||"mozPointerLockElement"in document,uint32array:"Uint32Array"in window},e=!0,f=["<table><tbody>"];if(a)a.forEach(b);else for(c in d)b(c);return f.push("</tbody></table>"),d.all=e,d.html="<div>"+f.join("")+"</div>",d.browser=O876.Browser.getDetectedBrowserList(),d},checkHTML5:function(a){a||(a="HTML 5 Application");var b=O876.Browser.getHTML5Status();if(!b.all){var c=O876.Browser.STRINGS[O876.Browser.LANGUAGE];return document.body.innerHTML='<div style="color: #AAA; font-family: monospace; background-color: black; border: solid 4px #666; padding: 8px"><h1>'+a+"</h1><p>"+c.wontrun+" ("+b.browser.join(", ")+").<br/>"+c.install+"</p>"+b.html+'<p style="color: #888; font-style: italic">'+c.legend+"</p></div>",!1}return b.all}}),O2.createObject("O876.CanvasFactory",{defaultImageSmoothing:!1,getCanvas:function(a,b,c){var d=document.createElement("canvas"),e=d.getContext("2d");return a&&b&&(d.width=a,d.height=b),void 0===c&&(c=O876.CanvasFactory.defaultImageSmoothing),O876.CanvasFactory.setImageSmoothing(e,c),c&&(d.style.imageRendering="pixelated"),d},setImageSmoothing:function(a,b){a.mozImageSmoothingEnabled=b,a.msImageSmoothingEnabled=b,a.imageSmoothingEnabled=b},getImageSmoothing:function(a){return a.imageSmoothingEnabled},cloneCanvas:function(a){var b=O876.CanvasFactory.getCanvas(a.width,a.height,O876.CanvasFactory.getImageSmoothing(a.getContext("2d")));return b.getContext("2d").drawImage(a,0,0),b}}),O2.createClass("O876.Easing",{xStart:0,xEnd:0,x:0,nTime:0,iTime:0,fWeight:1,pFunction:null,from:function(a){return this.xStart=this.x=a,this},to:function(a){return this.xEnd=a,this},during:function(a){return this.nTime=a,this.iTime=0,this},use:function(a){switch(typeof a){case"string":this.pFunction=this["_"+a].bind(this);break;case"function":this.pFunction=a;break;default:throw new Error("unknown function type")}return this},next:function(a){void 0===a?a=++this.iTime:this.iTime=a;var b=this.pFunction;if("function"!=typeof b)throw new Error("easing function is invalid : "+b);var c=b(a/this.nTime);return this.x=this.xEnd*c+this.xStart*(1-c),this},val:function(){return this.x},over:function(){return this.iTime>=this.nTime},_linear:function(a){return a},_smoothstep:function(a){return a*a*(3-2*a)},_smoothstepX2:function(a){return a=a*a*(3-2*a),a*a*(3-2*a)},_smoothstepX3:function(a){return a=a*a*(3-2*a),a=a*a*(3-2*a),a*a*(3-2*a)},_squareAccel:function(a){return a*a},_squareDeccel:function(a){return 1-(1-a)*(1-a)},_cubeAccel:function(a){return a*a*a},_cubeDeccel:function(a){return 1-(1-a)*(1-a)*(1-a)},_cubeInOut:function(a){return a<.5?(a=2*a,a*a*a):(a=2*(1-a),a*a*a)},_sine:function(a){return Math.sin(a*Math.PI/2)},_cosine:function(a){return.5-.5*Math.cos(-a*Math.PI)},_weightAverage:function(a){return(a*(this.nTime-1)+this.fWeight)/this.nTime},_quinticBezier:function(a){var b=a*this.nTime,c=b*this.nTime;return 4*c-9*b+6*a}}),O2.createClass("Fairy.Animation",{_start:0,_index:0,_count:0,_duration:0,_time:0,_loop:0,_frame:0,nDirLoop:1,animate:function(a){if(this._count<=1||0===this._duration)return this._index+this._start;switch(this._time+=a,this._time>=this._duration&&(this._time-=this._duration,3==this._loop?this._index=Math.random()*this._count|0:this._index+=this.nDirLoop),this._time>=this._duration&&(this._index+=this.nDirLoop*(this._time/this._duration|0),this._time%=this._duration),this._loop){case 1:this._index>=this._count&&(this._index=0);break;case 2:this._index>=this._count&&(this._index=this._count-2,this.nDirLoop=-1),this._index<=0&&(this.nDirLoop=1,this._index=0);break;default:this._index>=this._count&&(this._index=this._count-1)}return this._frame=this._index+this._start,this},reset:function(){return this._index=0,this._time=0,this.nDirLoop=1,this}}),O2.mixin(Fairy.Animation,O876.Mixin.Prop),O2.createClass("Fairy.Collider",{_origin:null,_grid:null,_cellWidth:0,_cellHeight:0,__construct:function(){this._origin=new Fairy.Vector,this._grid=new Fairy.Grid,this._grid.on("rebuild",function(a){var b=new Fairy.Sector;b.x=a.x,b.y=a.y,a.cell=b})},sector:function(a,b){return void 0===b?this.grid().cell(a.x/this.cellWidth(),a.y/this.cellHeight()):this.grid().cell(a,b)},track:function(a){var b=a.data("__colliderSector"),c=a.flight().position().sub(this.origin()),d=a.dead()?null:this.sector(c);if(!d||!b||d!=b)return b&&b.remove(a),d&&d.add(a),a.data("__colliderSector",d),this},collides:function(a){var b=[],c=this.sector(a.flight().position().sub(this.origin()));if(!c)return b;var d,e,f=c.x,g=c.y,h=[],i=Math.max(0,f-1),j=Math.max(0,g-1),k=Math.min(this.width()-1,f+1),l=Math.min(this.height()-1,g+1);for(e=j;e<=l;++e)for(d=i;d<=k;++d)h=h.concat(this.sector(d,e).collides(a));return h}}),O2.mixin(Fairy.Collider,O876.Mixin.Prop),O2.mixin(Fairy.Collider,Fairy.Mixin.GridProxy),O2.createClass("Fairy.Flight",{_position:null,_wings:null,_forces:null,_speed:null,oWingRegistry:null,__construct:function(){this._position=new Fairy.Vector(0,0),this._wings=[],this._forces=[],this._speed=new Fairy.Vector,this.oWingRegistry={}},_applyForces:function(){for(var a=this._speed,b=this._forces;b.length;)a.trans(b.shift());this.move(a)},wing:function(a,b){switch(typeof a){case"undefined":return this;case"object":return this.wings().push(a),b&&(this.oWingRegistry[b]=a),this;case"string":return this.oWingRegistry[a];case"number":return this.wings()[a]}},move:function(a){this._position.trans(a)},flap:function(a,b){return this._wings.forEach(function(c){c.flap(a,b)}),this._applyForces(),this}}),O2.mixin(Fairy.Flight,O876.Mixin.Prop),O2.createClass("Fairy.Grid",{_cells:null,_width:0,_height:0,_rebuild:function(a,b){var c,d,e,f,g=[];for(d=0;d<b;d++){for(e=[],c=0;c<a;c++)f={x:c,y:d,width:a,height:b,cell:null},this.trigger("rebuild",f),e.push(f.cell);g.push(e)}this.cells(g)},cell:function(a,b,c){return a|=0,b|=0,void 0===c?b>=0&&b>=0&&b<this._height&&a<this._width?this._cells[b][a]:null:(b>=0&&b>=0&&b<this._height&&a<this._width&&(this._cells[b][a]=c),this)},width:function(a){return void 0!==a&&this._rebuild(a,this._height),this.prop("_width",a)},height:function(a){return void 0!==a&&this._rebuild(this._width,a),this.prop("_height",a)}}),O2.mixin(Fairy.Grid,O876.Mixin.Events),O2.mixin(Fairy.Grid,O876.Mixin.Prop),O2.extendClass("Fairy.LandLayer",Fairy.Layer,{_grid:null,_tileset:null,_view:null,__construct:function(){__inherited(),this._tileset=new Fairy.Tileset,this._grid=new Fairy.Grid,this._view=new Fairy.View},render:function(a){var b,c,d,e,f=this.tileset(),g=this.view().points(),h=f.tileWidth(),i=f.tileHeight(),j=g[0].x,k=g[0].y,l=g[1].x,m=g[1].y,n=j/h|0,o=k/i|0,p=l-j,q=m-k,r=p/h|0,s=q/i|0,t=(h-j)%h,u=(i-k)%i,v=f.tiles();for(c=0;c<=s+1;++c)for(e=c*i,b=0;b<=r+1;++b)d=f.rect(this._grid.cell(b-n,c-o)),a.drawImage(v,d.x,d.y,d.width,d.height,b*h-t,e-u,h,i);return this}}),O2.mixin(Fairy.LandLayer,O876.Mixin.Prop),O2.mixin(Fairy.LandLayer,Fairy.Mixin.GridProxy),O2.createClass("Fairy.Layer",{_origin:null,_view:null,_width:0,_height:0,__construct:function(){this._origin=new Fairy.Vector,this._view=new Fairy.View},render:function(a){}}),O2.mixin(Fairy.Layer,O876.Mixin.Prop),O2.createClass("Fairy.Mobile",{_shape:null,_sprite:null,_flight:null,_dead:!1,_collider:null,flight:function(a){return this._shape&&void 0!==a&&this._shape.flight(a),this.prop("_flight",a)},shape:function(a){return this._shape&&this._shape.flight(this._flight),this.prop("_shape",a)},render:function(a,b){this._sprite.render(a,this._flight,b)},process:function(a){this._sprite.process(a),this._flight.flap(this,a),this._collider&&this._collider.track(this)}}),O2.mixin(Fairy.Mobile,O876.Mixin.Data),O2.mixin(Fairy.Mobile,O876.Mixin.Prop),O2.extendClass("Fairy.MobileLayer",Fairy.Layer,{_mobiles:null,_collider:null,_sorted:!0,_visibleMobiles:null,__construct:function(){__inherited(),this._mobiles=[],this._collider=new Fairy.Collider},_sort:function(a,b){return a.flight().position().y-b.flight().position().y},sort:function(a){return this._sort=a,this},process:function(a){this.view();return this.visibleMobiles(this.mobiles().filter(function(a){return this.view().hits(a.shape())},this)).visibleMobiles().sort(this._sort),this},render:function(a){var b=Fairy.Vector.ZERO.sub(this.origin().add(this.view().offset()));return this.visibleMobiles().forEach(function(c){c.render(a,b)}),this}}),O2.mixin(Fairy.MobileLayer,O876.Mixin.Prop),O2.extendClass("Fairy.Rect",Fairy.Shape,{_p1:null,_p2:null,__construct:function(){__inherited(),this._p1=new Fairy.Vector,this._p2=new Fairy.Vector},p1:function(a){return void 0===a?this._p1:(this._p1=a,this)},p2:function(a){return void 0===a?this._p2:(this._p2=a,this)},points:function(){if(!this._flight)throw new Error("flight is not defined in this rect");var a=this._p1,b=this._p2,c=Math.min(a.x,b.x),d=Math.min(a.y,b.y),e=Math.max(a.x,b.x),f=Math.max(a.y,b.y),g=this.flight().position();return[new Fairy.Vector(c,d).trans(g),new Fairy.Vector(e-1,f-1).trans(g)]},_getCollisionAxis:function(a,b,c){return a<b?1:a>c?3:2},_getCollisionSector:function(a){var b=this.points(),c=b[0],d=b[1],e=this._getCollisionAxis(a.x,c.x,d.x),f=this._getCollisionAxis(a.y,c.y,d.y);switch(e<<4|f){case 17:return 1;case 18:return 4;case 19:return 7;case 33:return 2;case 34:return 5;case 35:return 8;case 49:return 3;case 50:return 6;case 51:return 9}},inside:function(a){var b=this.points();return this.between(a.x,b[0].x,b[1].x)&&this.between(a.y,b[0].y,b[1].y)},hits:function(a){if(!__inherited(a))return!1;var b=(this.points(),a.points()),c=this._getCollisionSector(b[0]),d=this._getCollisionSector(b[1]);if(d<c)throw new Error("weird error : unexpected collision case "+d+" > "+c);switch(c<<4|d){case 17:case 18:case 19:case 20:case 23:case 34:case 35:case 51:case 54:case 57:case 68:case 71:case 102:case 105:case 119:case 120:case 121:case 136:case 137:case 153:return!1;default:return!0}}}),O2.mixin(Fairy.Rect,O876.Mixin.Prop),O2.createClass("Fairy.Sector",{_objects:null,x:-1,y:-1,__construct:function(){this._objects=[]},add:function(a){this._objects.push(a)},remove:function(a){var b=this._objects,c=b.indexOf(a);c>=0&&b.splice(c,1)},count:function(){return this._objects.length},get:function(a){return this._objects[a]||null},collides:function(a){var b=a.shape();return this._objects.filter(function(c){return c!=a&&b.hits(c.shape())})}}),O2.mixin(Fairy.Sector,O876.Mixin.Prop),O2.createClass("Fairy.Shape",{_flight:null,_tangibility:1,__construct:function(){},between:function(a,b,c){return b==c?a==b:b<c?a>=b&&a<=c:a>=c&&a<=b},squareDistance:function(a,b){var c=a.x,d=a.y,e=b.x,f=b.y;return(e-c)*(e-c)+(f-d)*(f-d)},distance:function(a,b){return Math.sqrt(this.squareDistance(a,b))},nearer:function(a,b,c){return c*c>this.squareDistance(a,b)},inside:function(a){return!1},points:function(){return[]},hits:function(a){return 0!==(a.tangibility()&this.tangibility())}}),O2.mixin(Fairy.Shape,O876.Mixin.Prop),O2.createClass("Fairy.Sprite",{_origin:null,_color:"red",_tileset:null,_animations:null,_animation:null,_zoom:1,__construct:function(){this._origin=new Fairy.Vector,this._animations=[]},process:function(a){this._animation.animate(a)},animation:function(a){return void 0===a?this._animation:(this._animation=this.animations()[a],this)},render:function(a,b,c){var d=0,e=0;c&&(d+=c.x,e+=c.y);var f=this._origin,g=b.position(),h=this.animation().frame(),i=this.tileset(),j=(i.tileWidth(),i.tileHeight(),i.rect(h)),k=this._zoom;a.drawImage(i.tiles(),j.x,j.y,j.width,j.height,g.x-(f.x-d)*k,g.y-(f.y-e)*k,j.width*k,j.height*k)}}),O2.mixin(Fairy.Sprite,O876.Mixin.Prop),O2.createClass("Fairy.Tileset",{_tiles:null,_tileWidth:0,_tileHeight:0,_rects:null,__construct:function(){this._rects=[]},rect:function(a){var b=this._rects[a];if(!b){var c=this._tiles.width,d=(this._tiles.height,a*this._tileWidth),e=d%c,f=(d/c|0)*this._tileHeight;b={x:e,y:f,width:this._tileWidth,height:this._tileHeight},this._rects[a]=b}return b}}),O2.mixin(Fairy.Tileset,O876.Mixin.Prop),O2.createClass("Fairy.Vector",{x:0,y:0,__construct:function(a,b){this.set(a,b)},set:function(a,b){return void 0!==a&&(void 0===b?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b)),this},trans:function(a){return this.x+=a.x,this.y+=a.y,this},scale:function(a){return this.x*=a,this.y*=a,this},normalize:function(){return this.scale(1/this.norm())},add:function(a){return this.clone().trans(a)},sub:function(a){var b=this.clone();return b.x-=a.x,b.y-=a.y,b},mul:function(a){return this.clone().scale(a)},div:function(a){return this.mul(1/a)},clone:function(){return new Fairy.Vector(this)},norm:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}}),Fairy.Vector.ZERO=new Fairy.Vector(0,0),O2.extendClass("Fairy.View",Fairy.Rect,{_offset:null,_width:0,_height:0,__construct:function(){__inherited(),this.flight(new Fairy.Flight),this.offset(new Fairy.Vector),this.p1(new Fairy.Vector(0,0)),this.p2(new Fairy.Vector(0,0))},points:function(){return this._p2.x=this._width,this._p2.y=this._height,__inherited().map(function(a){return a.sub(this._offset)},this)},center:function(){this.offset(new Fairy.Vector(this.width()>>1,this.height()>>1))}}),O2.mixin(Fairy.View,O876.Mixin.Prop),O2.createClass("Fairy.Wing",{__construct:function(){},flap:function(a){}}),O2.mixin(Fairy.Wing,O876.Mixin.Prop),O2.extendClass("Fairy.Wings.Air",Fairy.Wing,{_factor:1,__construct:function(){__inherited()},flap:function(a,b){a.flight().speed().scale(this.factor())}}),O2.mixin(Fairy.Wings.Air,O876.Mixin.Prop),O2.extendClass("Fairy.Wings.BumpFloor",Fairy.Wing,{_bottom:0,__construct:function(){__inherited()},flap:function(a,b){var c=a.flight();c.position().y>this._bottom&&(c.position().y=this._bottom,c.speed().y*=-.8)}}),O2.mixin(Fairy.Wings.BumpFloor,O876.Mixin.Prop),O2.extendClass("Fairy.Wings.Gravity",Fairy.Wing,{_force:null,__construct:function(){__inherited(),this._force=new Fairy.Vector},flap:function(a,b){a.flight().forces().push(this.force())}}),O2.mixin(Fairy.Wings.Gravity,O876.Mixin.Prop),O2.extendClass("Fairy.Wings.Linear",Fairy.Wing,{_speed:null,__construct:function(){__inherited(),this._speed=new Fairy.Vector},flap:function(a,b){a.flight().move(this.speed())}}),O2.mixin(Fairy.Wings.Linear,O876.Mixin.Prop),O2.extendClass("Fairy.Wings.Shock",Fairy.Wing,{_shock:null,__construct:function(){__inherited()},flap:function(a,b){var c=a.flight();this.shock()&&(c.forces().push(this.shock().clone()),this.shock(null))}}),O2.mixin(Fairy.Wings.Shock,O876.Mixin.Prop),O2.extendClass("Fairy.WorldLayer",Fairy.Layer,{_view:null,_zoneWidth:0,_zoneHeight:0,_zones:null,_moreZones:!1,__construct:function(){this._view=new Fairy.View,this._zones={}},view:function(a){return this.prop("_view",a)},zoneWidth:function(a){return this.prop("_zoneWidth",a)},zoneHeight:function(a){return this.prop("_zoneHeight",a)},zones:function(a){return this.prop("_zones",a)},moreZones:function(a){return this.prop("_moreZone",a)},update:function(){var a=this.view().points(),b=this.zoneWidth(),c=this.zoneHeight(),d=a[0].x,e=a[0].y,f=Math.floor(d/b),g=Math.floor(e/c),h=Math.floor(a[1].x/b),i=Math.floor(a[1].y/c);this.moreZones()&&(--f,--g,++h,++i);for(var j,k,l={},m=this.zones(),n={d:[],n:[],a:[]},o=g;o<=i;++o)for(k=f;k<=h;++k)j=k.toString()+":"+o.toString(),m[j]?(n.a.push(j),l[j]=m[j],delete m[j]):(l[j]={x:k,y:o,key:j,canvas:null},n.n.push(j));for(j in m)n.d.push(j);this.zones(l);for(var p in n)n[p].forEach(function(a){this.trigger("zone."+p,l[a])}.bind(this));return this},render:function(a){var b,c=this.zones(),d=this.view().points(),e=this.zoneWidth(),f=d[0].x,g=d[0].y;for(var h in c)b=c[h],b.canvas&&a.drawImage(b.canvas,b.x*e-f,b.y*e-g)}}),O2.mixin(Fairy.WorldLayer,O876.Mixin.Prop),O2.mixin(Fairy.WorldLayer,O876.Mixin.Events),O2.createClass("O876.Perlin",{_rand:null,_width:0,_height:0,_octaves:0,_interpolate:null,__construct:function(){this._rand=new O876.Random,this.interpolation("cosine")},generateWhiteNoise:function(a,b){for(var c,d,e=[],f=0;f<b;++f){for(c=[],d=0;d<a;++d)c.push(this._rand.rand());e.push(c)}return e},linearInterpolate:function(a,b,c){return a*(1-c)+c*b},cosineInterpolate:function(a,b,c){var d=(1-Math.cos(c*Math.PI))/2;return a*(1-d)+b*d},interpolation:function(a){switch(typeof a){case"string":if(!(a+"Interpolate"in this))throw new Error('only "linear" or "cosine" interpolation');return this._interpolate=this[a+"Interpolate"],this;case"function":return this._interpolate=a,this;case"undefined":return this._interpolate}return this},generateSmoothNoise:function(a,b){for(var c,d,e,f,g,h,i=a.length,j=a[0].length,k=[],l=1<<b,m=1/l,n=[],o=[],p=0;p<j;++p){for(o[0]=(p/l|0)*l,o[1]=(o[0]+l)%j,d=(p-o[0])*m,c=[],h=0;h<i;++h)n[0]=(h/l|0)*l,n[1]=(n[0]+l)%i,e=(h-n[0])*m,f=this._interpolate(a[o[0]][n[0]],a[o[1]][n[0]],d),g=this._interpolate(a[o[0]][n[1]],a[o[1]][n[1]],d),c.push(this._interpolate(f,g,e));k.push(c)}return k},generatePerlinNoise:function(a,b){for(var c=a.length,d=a[0].length,e=[],f=.5,g=0;g<b;++g)e.push(this.generateSmoothNoise(a,g));var h,i,j,k=[],l=1,m=0;for(i=0;i<d;++i){for(j=[],h=0;h<c;++h)j.push(0);k.push(j)}for(var n=b-1;n>=0;--n)for(l*=f,m+=l,i=0;i<d;++i)for(j=[],h=0;h<c;++h)k[i][h]+=e[n][i][h]*l;for(i=0;i<d;++i)for(j=[],h=0;h<c;++h)k[i][h]/=m;return k},hash:function(a){return a=61^a^a>>16,a+=a<<3,a^=a>>4,a=668265261*a,a^=a>>15},getPointHash:function(a,b){for(var c=this.hash(a).toString().split(""),d=this.hash(b).toString().split(""),e=c.shift()+d.shift()+".";c.length||d.length;)c.length&&(e+=c.shift()),d.length&&(e+=d.shift());return parseFloat(e)},generate:function(a,b){function c(a,b){var c=f.getPointHash(a,b);return f.rand().seed(c),f.generateWhiteNoise(f.width(),f.height())}function d(a){for(var b,c=f.height(),d=[],e=0;e<3;++e)for(b=0;b<c;++b)d.push(a[e][0][b].concat(a[e][1][b],a[e][2][b]));return d}function e(a){var b=f.width(),c=f.height();return a.slice(c,2*c).map(function(a){return a.slice(b,2*b)})}var f=this,g=[[c(a-1,b-1),c(a,b-1),c(a+1,b-1)],[c(a-1,b),c(a,b),c(a+1,b)],[c(a-1,b+1),c(a,b+1),c(a+1,b+1)]],h=d(g),i=this.generatePerlinNoise(h,this.octaves()),j=e(i);return j},render:function(a,b,c){var d=new O876.Rainbow,c=c||d.gradient({0:"#008",49:"#00F",50:"#840",84:"#0A0",85:"#888",99:"#FFF"}),e=a.length,f=a[0].length,g=c.length,h=b.createImageData(f,e),i=h.data,d=new O876.Rainbow;a.forEach(function(a,b){a.forEach(function(a,e){var h=b*f+e<<2,j=d.parse(c[a*g|0]);i[h]=j.r,i[h+1]=j.g,i[h+2]=j.b,i[h+3]=255})}),b.putImageData(h,0,0)}}),O2.mixin(O876.Perlin,O876.Mixin.Prop),O2.createClass("O876.Philter",{_oFilters:null,perf:null,__construct:function(){"performance"in window?this.perf=performance:this.perf=Date,this.config({kernel:[[0,0,0],[0,1,0],[0,0,0]],bias:0,factor:1,more:!1,radius:1,level:50,left:0,top:0,width:null,height:null,right:0,bottom:0,red:!0,green:!0,blue:!0,alpha:!0,channels:"rgba",command:"",sync:!0,delay:256})},config:function(a,b){return this.data(a,b)},init:function(a,b){var c=O876.typeMap(arguments,"short");switch(c){case"s":case"su":this.config("command",a);break;case"so":this.config(b),this.config("command",a);break;case"o":case"ou":this.config(a);break;case"sf":return void(this._oFilters[a]=b);default:throw new Error("bad parameter format")}var d=this.config("channels").toLowerCase();this.config("red",d.indexOf("r")>=0),this.config("green",d.indexOf("g")>=0),this.config("blue",d.indexOf("b")>=0),this.config("alpha",d.indexOf("a")>=0)},buildShadowCanvas:function(a){var b=a.getContext("2d"),c=a.width,d=a.height,e=b.getImageData(0,0,c,d),f=new Uint32Array(e.data.buffer);return{canvas:a,context:b,imageData:e,pixelData:e.data,pixels:f,width:c,height:d,_p:!1}},commitShadowCanvas:function(a){a._p&&a.context.putImageData(a.imageData,0,0)},getRegion:function(a){var b=this.config("left"),c=this.config("top"),d=null!==this.config("width")?b+this.config("width")-1:null,e=null!==this.config("height")?c+this.config("height")-1:null;return d=null!==d?d:a.width-this.config("left")-1,e=null!==e?e:a.height-this.config("right")-1,{xs:b,ys:c,xe:d,ye:e}},getPixel:function(a,b,c,d){if(void 0===d&&(d={}),b>=0&&c>=0&&b<a.width&&c<a.height){var e=c*a.width+b,f=a.pixels[e];return d.r=255&f,d.g=f>>8&255,d.b=f>>16&255,d.a=f>>24&255,d}return null},setPixel:function(a,b,c,d){if(b>=0&&c>=0&&b<a.width&&c<a.height){var e=c*a.width+b,f="a"in d?d.a<<24:4278190080&a.pixels[e];a.pixels[e]=d.r|d.g<<8|d.b<<16|f,a._p=!0}},pixelProcess:function(a,b,c){var d,e,f,g={},h={},i=(a.width,a.height,this.config("red")),j=this.config("green"),k=this.config("blue"),l=this.config("alpha"),m=this.config("factor"),n=this.config("bias"),h=this.getRegion(a),o=this.perf.now(),p=this.perf,q=this.config("delay"),r=!this.config("sync"),s=h.xs,t=h.ys,u=s,v=t,w=h.xe,x=h.ye;c?(u=c.x,v=c.y):this.trigger("progress",{value:0});this.getPixel,this.setPixel;for(e=v;e<=x;++e){for(d=u;d<=w;++d){this.getPixel(a,d,e,g);for(f in g)h[f]=g[f];b(d,e,g),i&&(h.r=0|Math.min(255,Math.max(0,m*g.r+n))),j&&(h.g=0|Math.min(255,Math.max(0,m*g.g+n))),k&&(h.b=0|Math.min(255,Math.max(0,m*g.b+n))),
l&&(h.a=0|Math.min(255,Math.max(0,m*g.a+n))),this.setPixel(a,d,e,h)}u=s;var y=p.now(),z=y-o;if(r&&z>q)return o=y,void requestAnimationFrame(function(){this.trigger("progress",{elapsed:z,value:(e-t)/(x-t)}),this.pixelProcess(a,b,{x:d,y:e})}.bind(this))}r&&(this.trigger("progress",{value:1}),this.trigger("pixelprocess.end",{sc:a}))},convolutionProcess:function(a){var b,c=this.buildShadowCanvas(a.canvas),d=a.width,e=a.height,f=this.config("kernel"),g=f.length,h=g>0?f[0].length:0;this.pixelProcess(a,function(a,i,j){var k,l,m,n,o,p={};for(o in j)j[o]=0;for(n=0;n<g;++n)for(m=0;m<h;++m)if(k=(a-(h>>1)+m+d)%d,l=(i-(g>>1)+n+e)%e,this.getPixel(c,k,l,p)){b=f[n][m];for(o in p)j[o]+=p[o]*b}}.bind(this))},filterContrast:function(a){var b=this.config("level"),c=259*(b+255)/(255*(259-b));this.pixelProcess(a,function(a,b,d){d.r=c*(d.r-128)+128,d.g=c*(d.g-128)+128,d.b=c*(d.b-128)+128})},filterNegate:function(a){this.pixelProcess(a,function(a,b,c){c.r=255-c.r,c.g=255-c.g,c.b=255-c.b})},filterColor:function(a){var b=this.config("kernel");if(b.length<3)throw new Error("color kernel must be 3x3 sized");if(b[0].length<3||b[1].length<3||b[2].length<3)throw new Error("color kernel must be 3x3 sized");this.pixelProcess(a,function(a,c,d){var e=d.r*b[0][0]+d.g*b[0][1]+d.b*b[0][2],f=d.r*b[1][0]+d.g*b[1][1]+d.b*b[1][2],g=d.r*b[2][0]+d.g*b[2][1]+d.b*b[2][2];d.r=e,d.g=f,d.b=g})},filterNoise:function(a){var b=this.config("level");this.pixelProcess(a,function(a,c,d){var e=b*(Math.random()-.5);d.r=0|Math.min(255,Math.max(0,d.r+e)),d.g=0|Math.min(255,Math.max(0,d.g+e)),d.b=0|Math.min(255,Math.max(0,d.b+e))})},buildGaussianBlurMatrix:function(a){var b,c,d,e=Math.max(1,Math.ceil(3*a)),f=[];for(c=-e;c<=e;++c){for(b=[],d=-e;d<=e;++d)b.push(1/(2*Math.PI*a*a)*Math.exp(-(d*d+c*c)/(2*a*a)));f.push(b)}return f},filterHSL:function(a){function b(a,b,c){a/=255,b/=255,c/=255;var d,e,f=Math.max(a,b,c),g=Math.min(a,b,c),h=(f+g)/2;if(f==g)d=e=0;else{var i=f-g;switch(e=h>.5?i/(2-f-g):i/(f+g),f){case a:d=(b-c)/i+(b<c?6:0);break;case b:d=(c-a)/i+2;break;case c:d=(a-b)/i+4}d/=6}return[d,e,h]}function c(a,b,c){return c<0&&++c,c>1&&--c,c<1/6?a+6*(b-a)*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a}function d(a,b,d){var e,f,g;if(0===b)e=f=g=d;else{var h=d<.5?d*(1+b):d+b-d*b,i=2*d-h;e=c(i,h,a+1/3),f=c(i,h,a),g=c(i,h,a-1/3)}return[255*e,255*f,255*g]}var e=this.config("hue")||0,f=this.config("saturation")||0,g=this.config("lightness")||0;this.pixelProcess(a,function(a,c,h){var i=b(h.r,h.g,h.b),j=(i[0]+e+1)%1,k=Math.min(1,Math.max(0,i[1]+f)),l=Math.min(1,Math.max(0,i[2]+g));j+=e;var m=d(j,k,l);h.r=m[0],h.g=m[1],h.b=m[2]})},filterKuwahara:function(a){function b(b,c){var d=f.getPixel(a,Math.min(h-1,Math.max(0,b)),Math.min(g-1,Math.max(0,c)));return d.r/=255,d.g/=255,d.b/=255,d}function c(a,c){var d=b(a,c),e=Math.max(d.r,d.g,d.b),f=Math.min(d.r,d.g,d.b);return(e+f)/2}function d(a,d,e,f){var g,h,i,j,k,l=1,m=0,n=0,o=0,p=0,q=0;for(i=d;i<=f;++i)for(h=a;h<=e;++h)j=c(h,i),k=b(h,i),n+=k.r,o+=k.g,p+=k.b,++q,j<l&&(l=j),j>m&&(m=j);return g=m-l,mean_r=n/q,mean_g=o/q,mean_b=p/q,{mean:{r:mean_r,g:mean_g,b:mean_b},variance:g}}function e(a,b,c){function e(a,b,c,e){var j=d(a,b,c,e);j.variance<i&&(f=j.mean.r,g=j.mean.g,h=j.mean.b,i=j.variance)}var f,g,h,i=1;return e(a-c,b-c,a,b),e(a,b-c,a+c,b),e(a,b,a+c,b+c),e(a-c,b,a,b+c),{r:255*f|0,g:255*g|0,b:255*h|0}}var f=this,g=a.height,h=a.width,i=this.config("radius");this.pixelProcess(a,function(a,b,c){var d=e(a,b,i);c.r=d.r,c.g=d.g,c.b=d.b})},run:function(a,b,c){this.init(b,c);var d=this.perf.now(),e=this.buildShadowCanvas(a);switch(this.one("pixelprocess.end",function(a){this.commitShadowCanvas(a.sc),this.trigger("complete",this.config())}.bind(this)),this.config("command")){case"contrast":this.filterContrast(e);break;case"negate":this.filterNegate(e);break;case"grayscale":this.config("kernel",[[.3,.59,.11],[.3,.59,.11],[.3,.59,.11]]),this.filterColor(e);break;case"sepia":this.config("kernel",[[.393,.769,.189],[.349,.686,.168],[.272,.534,.131]]),this.filterColor(e);break;case"color":this.filterColor(e);break;case"noise":this.filterNoise(e);break;case"hsl":this.filterHSL(e);break;case"blur":this.config("radius")<2?this.config("kernel",[[0,.2,0],[.2,.2,.2],[0,.2,0]]):this.config("kernel",this.buildGaussianBlurMatrix(Math.max(2,this.config("radius"))/3)),this.convolutionProcess(e);break;case"convolution":this.convolutionProcess(e);break;case"pixelmap":this.pixelProcess(e,this.config("func"));break;case"sharpen":this.config("more")?this.config("kernel",[[1,1,1],[1,-7,1],[1,1,1]]):(this.config("kernel",[[-1,-1,-1,-1,-1],[-1,2,2,2,-1],[-1,2,8,2,-1],[-1,2,2,2,-1],[-1,-1,-1,-1,-1]]),this.config("factor",1/8)),this.convolutionProcess(e);break;case"edges":this.config("alpha",!1),this.config("kernel",[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]]),this.convolutionProcess(e);break;case"emboss":this.config("sobel")?this.config("kernel",[[-1,-2,-1],[0,0,0],[1,2,1]]):this.config("more")?this.config("kernel",[[-2,-1,0],[-1,1,1],[0,1,2]]):this.config("kernel",[[-1,-1,0],[-1,1,1],[0,1,1]]),this.convolutionProcess(e);break;case"kuwahara":this.filterKuwahara(e)}if(this.config("sync")){this.commitShadowCanvas(e);var f=this.perf.now();this.data("duration",f-d)}}}),O2.mixin(O876.Philter,O876.Mixin.Data),O2.mixin(O876.Philter,O876.Mixin.Events),O2.createClass("O876.Rainbow",{COLORS:{aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},rgba:function(a){return this._buildRGBAFromStructure(this.parse(a))},parse:function(a){if("object"==typeof a)return a;if("number"==typeof a)return this._buildStructureFromInt(a);if("string"==typeof a)switch(a=a.toLowerCase(),a in this.COLORS&&(a=this.COLORS[a]),a.length){case 3:return this._buildStructureFromString3(a);case 4:if("#"===a[0])return this._buildStructureFromString3(a.substr(1));throw new Error("invalid color structure");case 6:return this._buildStructureFromString6(a);case 7:if("#"===a[0])return this._buildStructureFromString6(a.substr(1));throw new Error("invalid color structure");default:var b=a.match(/^rgb\( *([0-9]{1,3}) *, *([0-9]{1,3}) *, *([0-9]{1,3}) *\)$/);if(b)return{r:0|b[1],g:0|b[2],b:0|b[3]};if(b=a.match(/^rgba\( *([0-9]{1,3}) *, *([0-9]{1,3}) *, *([0-9]{1,3}) *, *([.0-9]+) *\)$/))return{r:0|b[1],g:0|b[2],b:0|b[3],a:parseFloat(b[4])};throw new Error("invalid color structure "+a)}},spectrum:function(a,b,c){function d(a,b){if(void 0===a)throw new Error("first color is undefined");if(void 0===b)throw new Error("second color is undefined");return{r:a.r+b.r>>1,g:a.g+b.g>>1,b:a.b+b.b>>1}}function e(a,b,c,f,g){var i=d(b,c),j=f+g>>1;return--h<0?a:(Math.abs(f-g)>1&&(e(a,b,i,f,j),e(a,i,c,j,g)),a[f]=b,a[g]=c,a)}var f=this.parse(a),g=this.parse(b),h=100;return e([],f,g,0,c-1).map(function(a){return this.rgba(a)},this)},gradient:function(a){var b,c,d=[],e=null,f=0;for(var g in a)c=0|g,b=a[g],null!==e?d=d.concat(this.spectrum(e,b,c-f+1).slice(1)):d[c]=this.rgba(b),e=b,f=c;return d},_buildStructureFromInt:function(a){var b=a>>16&255,c=a>>8&255,d=255&a;return{r:b,g:c,b:d}},_buildStructureFromString3:function(a){var b=parseInt("0x"+a[0]+a[0]),c=parseInt("0x"+a[1]+a[1]),d=parseInt("0x"+a[2]+a[2]);return{r:b,g:c,b:d}},_buildStructureFromString6:function(a){var b=parseInt("0x"+a[0]+a[1]),c=parseInt("0x"+a[2]+a[3]),d=parseInt("0x"+a[4]+a[5]);return{r:b,g:c,b:d}},_buildRGBAFromStructure:function(a){var b="rgb",c=a.r.toString()+", "+a.g.toString()+", "+a.b.toString();return"a"in a&&(b+="a",c+=", "+a.a.toString()),b+"("+c+")"},_buildString3FromStructure:function(a){var b=(a.r>>4&15).toString(16),c=(a.g>>4&15).toString(16),d=(a.b>>4&15).toString(16);return b+c+d}}),O2.createClass("O876.Random",{_seed:1,__construct:function(){this._seed=Math.random()},seed:function(a){return this.prop("_seed",a)},_rand:function(){return this._seed=Math.abs(1e12*Math.sin(this._seed)%1e6/1e6)},rand:function(a,b){var c=this._rand();switch(typeof a){case"undefined":return c;case"number":return void 0===b&&(b=a-1,a=0),Math.max(a,Math.min(b,(b-a+1)*c+a|0));case"object":return Array.isArray(a)?a.length>0?a[c*a.length|0]:void 0:this.rand(Object.keys(a));default:return c}}}),O2.mixin(O876.Random,O876.Mixin.Prop),O2.createClass("O876.Snail",{getLevelSquareWidth:function(a){return 2*a+1},getLevelItemCount:function(a){var b=this.getLevelSquareWidth(a);return 4*b-4},getLevel:function(a,b){return a=Math.abs(a),b=Math.abs(b),Math.max(a,b)},crawl:function(a,b){if(void 0===b&&(b=a),a>b)throw new Error("levelMin must be lower or equal levelMax");if(a<0)return[];var c,d,e,f=[];for(e=-b;e<=b;++e)for(d=-b;d<=b;++d)c=this.getLevel(d,e),c>=a&&c<=b&&f.push({x:d,y:e});return f}}),O2.createClass("O876.SoundSystem",{CHAN_MUSIC:99,HAVE_NOTHING:0,HAVE_METADATA:1,HAVE_CURRENT_DATA:2,HAVE_FUTURE_DATA:3,HAVE_ENOUGH_DATA:4,oBase:null,aChans:null,oMusicChan:null,nChanIndex:-1,bMute:!1,bAllUsed:!1,sCrossFadeTo:"",bCrossFading:!1,sSndPlayedFile:"",fSndPlayedVolume:0,nSndPlayedTime:0,sFormat:"",sPath:"",oInterval:null,__construct:function(){this.oBase=document.body,this.aChans=[],this.aAmbient=[],this.aChans=[],this._createMusicChannel()},worthPlaying:function(a,b,c){return(this.nSndPlayedTime!=a||this.sSndPlayedFile!=b||this.fSndPlayedVolume!=c)&&(this.sSndPlayedFile=b,this.fSndPlayedVolume=c,this.nSndPlayedTime=a,!0)},mute:function(){this.bMute||(this.oMusicChan.pause(),this.bMute=!0)},unmute:function(){this.bMute&&(this.oMusicChan.play(),this.bMute=!1)},free:function(){this.setChannelCount(0),this._freeMusicChannel()},setChannelCount:function(a){for(var b=this.aChans;b.length>a;)b.pop().remove();for(;b.length<a;)this._addChan()},getChannelCount:function(){return this.aChans.length},playMusic:function(a,b){var c=this.oMusicChan;c.loop=!0,this._setChanSource(c,a),c.load(),this.bMute||c.play()},setPath:function(a){this.sPath=a},crossFadeMusic:function(a){if(void 0===a)throw new Error("sound file is not specified");if(this.bCrossFading)return void(this.sCrossFadeTo=a);var b=100,c=-10;this.bCrossFading=!0,this.oInterval&&window.clearInterval(this.oInterval),this.oInterval=window.setInterval(function(){b+=c,this.oMusicChan.volume=Math.min(1,Math.max(0,b/100)),b<=0&&(this.playMusic(a),this.oMusicChan.volume=1,window.clearInterval(this.oInterval),this.oInterval=null,this.bCrossFading=!1,this.sCrossFadeTo&&(this.crossFadeMusic(this.sCrossFadeTo),this.sCrossFadeTo=""))}.bind(this),100)},play:function(a,b){var c=null,d=null;return this.bMute||void 0===a?-1:c==this.CHAN_MUSIC?(this.playMusic(a),c):this._hasChan()?(null===c&&(c=this._getFreeChan(a)),d=this.aChans[c],null===d?-1:(d.__file!=a?(this._setChanSource(d,a),d.__file=a,d.load()):d.readyState>this.HAVE_NOTHING&&(d.currentTime=0,d.play()),void(void 0!==b&&(d.volume=b)))):(d=null,-1)},_setChanSource:function(a,b){if(void 0==b)throw new Error("undefined sound");a.src=this.sPath+"/"+this.sFormat+"/"+b+"."+this.sFormat},_createChan:function(){var a=document.createElement("audio");return this.oBase.appendChild(a),a},_addChan:function(){var a=this._createChan();return a.setAttribute("preload","auto"),a.setAttribute("autoplay","autoplay"),a.__file="",this.aChans.push(a),this.bAllUsed=!1,a},_isChanFree:function(a,b){if(a==this.CHAN_MUSIC)return this.oMusicChan.ended;a=Math.max(0,Math.min(this.aChans.length-1,a));var c=this.aChans[a];if(void 0===b)return c.ended;var d=""===c.__file,e=c.ended,f=b==c.__file;return d||e&&f},_getFreeChan:function(a){if(!this._hasChan())return-1;var b,c;for(b=0,c=this.aChans.length;b<c;++b)if(this._isChanFree(b,a))return b;for(b=0,c=this.aChans.length;b<c;++b)if(this._isChanFree(b))return b;return this.nChanIndex=(this.nChanIndex+1)%this.aChans.length,this.nChanIndex},_hasChan:function(){return this.aChans.length>0},_freeMusicChannel:function(){this.oMusicChan&&(this.oMusicChan.remove(),this.oMusicChan=null)},_createMusicChannel:function(){if(this._freeMusicChannel(),this.oMusicChan=this._createChan(),this.oMusicChan.canPlayType("audio/ogg"))this.sFormat="ogg";else{if(!this.oMusicChan.canPlayType("audio/mp3"))throw new Error("neither ogg nor mp3 can be played back by this browser");this.sFormat="mp3"}}}),O2.createClass("O876.XHR",{_oInstance:null,aQueue:null,_bAjaxing:!1,pCurrentCallback:null,__construct:function(){this.aQueue=[]},getInstance:function(){return null===this._oInstance&&(this._oInstance=new XMLHttpRequest,this._oInstance.addEventListener("readystatechange",this._dataReceived.bind(this))),this._oInstance},_dataReceived:function(a){var b=a.target;if(b.readyState==XMLHttpRequest.DONE){var c=this.aQueue.shift();c&&(200==b.status?c.callback(b.responseText):c.callback(null,b.status.toString())),this.aQueue.length?this.runAjax():this._bAjaxing=!1}},runAjax:function(){this._bAjaxing=!0;var a=this.aQueue;if(a.length){var b=a[0],c=this.getInstance();c.open(b.method,b.url,!0),c.send(b.data)}},autoRunAjax:function(){this._bAjaxing||this.runAjax()},get:function(a,b){if(null===a)throw new Error("url is invalid");this.aQueue.push({method:"GET",data:null,url:a,callback:b}),this.autoRunAjax()},post:function(a,b,c){"object"==typeof b&&(b=JSON.stringify(b)),this.aQueue.push({method:"POST",data:b,url:a,callback:c}),this.autoRunAjax()},getSync:function(a){console.warn("Synchronous Ajax Query (url : "+a+") ! It is known that querying synchronously is bad for health and makes animals suffer.");var b=this.getInstance();if(b.open("GET",a,!1),b.send(null),200==b.status)return b.responseText;throw new Error("XHR failed to load: "+a+" ("+b.status.toString()+")")},postSync:function(a,b){console.warn("Synchronous Ajax Query (url : "+a+") ! It is known that querying synchronously is bad for health and makes animals suffer.");var c=this.getInstance();if(c.open("POST",a,!1),c.send(b),200==c.status)return c.responseText;throw new Error("XHR failed to post to: "+a+" ("+c.status.toString()+")")}}),O2.createObject("O876.parseSearch",function(a){if(a){var b=a.indexOf("?");if(!(b>=0))return{};a=a.substr(b+1)}else a=window.location.search.substr(1);for(var c,d=/\+/g,e=/([^&=]+)=?([^&]*)/g,f=a,g=function(a){return decodeURIComponent(a.replace(d," "))},h={};c=e.exec(f);)h[g(c[1])]=g(c[2]);return h}),O2.createObject("O876.typeMap",function(a,b){var c=Array.prototype.slice.call(a,0).map(function(a){var b=typeof a;switch(b){case"object":return null===a?"undefined":Array.isArray(a)?"array":"object";default:return b}});switch(b){case"short":return c.map(function(a){return a.charAt(0)}).join("");default:return c}});